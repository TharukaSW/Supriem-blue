// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ---------- ENUMS ----------

enum RoleName {
  ADMIN
  MANAGER
  USER
}

enum ItemType {
  RAW
  PRODUCT
  SERVICE
}

enum DocStatus {
  DRAFT
  CONFIRMED
  RECEIVED
  DISPATCHED
  DELIVERED
  CANCELLED
  ISSUED
  PAID
}

enum InvoiceType {
  SALES
  PURCHASE
}

enum MatchStatus {
  PENDING
  MATCHED
  MISMATCHED
}

enum PayMethod {
  CASH
  BANK
  CHEQUE
  CARD
  OTHER
}

enum MovementType {
  PURCHASE_RECEIPT
  PRODUCTION_OUTPUT
  SALES_DISPATCH
  ADJUSTMENT_IN
  ADJUSTMENT_OUT
  RETURN_IN
  RETURN_OUT
}

enum TxType {
  INCOME
  EXPENSE
  TRANSFER
}

// ---------- COMMON ----------

model Role {
  roleId      Int       @id @default(autoincrement()) @map("role_id")
  roleName    RoleName  @unique @map("role_name")
  idPrefix    String    @unique @map("id_prefix") @db.VarChar(10)
  description String?   @db.Text
  users       User[]

  @@map("roles")
}

// ---------- USERS / HR ----------

model User {
  userId       BigInt    @id @default(autoincrement()) @map("user_id")
  userCode     String    @unique @map("user_code") @db.VarChar(20)
  roleId       Int       @map("role_id")
  fullName     String    @map("full_name") @db.VarChar(120)
  username     String?   @unique @db.VarChar(80)
  email        String?   @db.VarChar(120)
  phone        String?   @db.VarChar(30)
  passwordHash String    @map("password_hash") @db.Text
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at")

  role            Role              @relation(fields: [roleId], references: [roleId])
  employeeProfile EmployeeProfile?
  attendances     AttendanceDaily[] @relation("UserAttendance")
  recordedAttendances AttendanceDaily[] @relation("RecordedBy")
  salaryRecords   SalaryRecord[]
  salaryPaymentsPaid SalaryPayment[] @relation("PaidBy")
  purchaseOrders  PurchaseOrder[]
  salesOrders     SalesOrder[]
  dispatches      Dispatch[]
  productionDays  ProductionDay[]
  stockMovements  StockMovement[]
  invoicesCreated Invoice[]         @relation("CreatedBy")
  invoicesMatched Invoice[]         @relation("MatchCheckedBy")
  payments        Payment[]
  expenses        Expense[]
  cashTransactions CashTransaction[]

  @@map("users")
}

model SalaryRange {
  salaryRangeId  BigInt   @id @default(autoincrement()) @map("salary_range_id")
  rangeName      String   @map("range_name") @db.VarChar(80)
  minSalary      Decimal  @default(0) @map("min_salary") @db.Decimal(12, 2)
  maxSalary      Decimal  @default(0) @map("max_salary") @db.Decimal(12, 2)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")

  employeeProfiles EmployeeProfile[]

  @@map("salary_ranges")
}

model EmployeeProfile {
  userId        BigInt       @id @map("user_id")
  nic           String?      @db.VarChar(20)
  address       String?      @db.Text
  joinedDate    DateTime?    @map("joined_date") @db.Date
  designation   String?      @db.VarChar(80)
  basicSalary   Decimal      @default(0) @map("basic_salary") @db.Decimal(12, 2)
  salaryRangeId BigInt?      @map("salary_range_id")
  otRate        Decimal      @default(0) @map("ot_rate") @db.Decimal(12, 2)
  notes         String?      @db.Text

  user        User         @relation(fields: [userId], references: [userId], onDelete: Cascade)
  salaryRange SalaryRange? @relation(fields: [salaryRangeId], references: [salaryRangeId])

  @@map("employee_profile")
}

model AttendanceDaily {
  attendanceId   BigInt    @id @default(autoincrement()) @map("attendance_id")
  userId         BigInt    @map("user_id")
  workDate       DateTime  @map("work_date") @db.Date
  timeIn         DateTime? @map("time_in")
  timeOut        DateTime? @map("time_out")
  systemHours    Decimal   @default(0) @map("system_hours") @db.Decimal(6, 2)
  systemOtHours  Decimal   @default(0) @map("system_ot_hours") @db.Decimal(6, 2)
  manualOtHours  Decimal   @default(0) @map("manual_ot_hours") @db.Decimal(6, 2)
  remarks        String?   @db.Text
  recordedBy     BigInt?   @map("recorded_by")
  createdAt      DateTime  @default(now()) @map("created_at")

  user     User  @relation("UserAttendance", fields: [userId], references: [userId])
  recorder User? @relation("RecordedBy", fields: [recordedBy], references: [userId])

  @@unique([userId, workDate])
  @@index([workDate])
  @@map("attendance_daily")
}

model SalaryPeriod {
  periodId   BigInt   @id @default(autoincrement()) @map("period_id")
  year       Int
  month      Int
  startDate  DateTime @map("start_date") @db.Date
  endDate    DateTime @map("end_date") @db.Date
  status     String   @default("OPEN") @db.VarChar(20)

  salaryRecords SalaryRecord[]

  @@unique([year, month])
  @@map("salary_periods")
}

model SalaryRecord {
  salaryRecordId BigInt   @id @default(autoincrement()) @map("salary_record_id")
  periodId       BigInt   @map("period_id")
  userId         BigInt   @map("user_id")
  baseSalary     Decimal  @default(0) @map("base_salary") @db.Decimal(12, 2)
  otHours        Decimal  @default(0) @map("ot_hours") @db.Decimal(8, 2)
  otAmount       Decimal  @default(0) @map("ot_amount") @db.Decimal(12, 2)
  allowances     Decimal  @default(0) @db.Decimal(12, 2)
  deductions     Decimal  @default(0) @db.Decimal(12, 2)
  totalPay       Decimal  @default(0) @map("total_pay") @db.Decimal(12, 2)
  status         String   @default("DRAFT") @db.VarChar(20)

  period   SalaryPeriod    @relation(fields: [periodId], references: [periodId])
  user     User            @relation(fields: [userId], references: [userId])
  payments SalaryPayment[]

  @@unique([periodId, userId])
  @@map("salary_records")
}

model SalaryPayment {
  salaryPaymentId BigInt    @id @default(autoincrement()) @map("salary_payment_id")
  salaryRecordId  BigInt    @map("salary_record_id")
  payDate         DateTime  @map("pay_date") @db.Date
  amount          Decimal   @db.Decimal(12, 2)
  method          PayMethod @default(CASH)
  referenceNo     String?   @map("reference_no") @db.VarChar(80)
  paidBy          BigInt?   @map("paid_by")
  createdAt       DateTime  @default(now()) @map("created_at")

  salaryRecord SalaryRecord @relation(fields: [salaryRecordId], references: [salaryRecordId])
  payer        User?        @relation("PaidBy", fields: [paidBy], references: [userId])

  @@map("salary_payments")
}

// ---------- MASTERS ----------

model Unit {
  unitId   Int     @id @default(autoincrement()) @map("unit_id")
  unitName String  @unique @map("unit_name") @db.VarChar(40)
  symbol   String? @db.VarChar(10)

  items Item[]

  @@map("units")
}

model ItemCategory {
  categoryId   Int    @id @default(autoincrement()) @map("category_id")
  categoryName String @unique @map("category_name") @db.VarChar(80)

  items Item[]

  @@map("item_categories")
}

model Item {
  itemId     BigInt   @id @default(autoincrement()) @map("item_id")
  itemCode   String   @unique @map("item_code") @db.VarChar(30)
  itemName   String   @map("item_name") @db.VarChar(150)
  itemType   ItemType @map("item_type")
  categoryId Int?     @map("category_id")
  unitId     Int?     @map("unit_id")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")

  category           ItemCategory?       @relation(fields: [categoryId], references: [categoryId])
  unit               Unit?               @relation(fields: [unitId], references: [unitId])
  supplierPrices     SupplierItemPrice[]
  customerPrices     CustomerItemPrice[]
  purchaseOrderLines PurchaseOrderLine[]
  salesOrderLines    SalesOrderLine[]
  productionLines    ProductionLine[]
  stockMovements     StockMovement[]
  stockBalance       StockBalance?
  invoiceLines       InvoiceLine[]

  @@unique([itemName, itemType])
  @@map("items")
}

model Supplier {
  supplierId   BigInt   @id @default(autoincrement()) @map("supplier_id")
  supplierCode String   @unique @map("supplier_code") @db.VarChar(30)
  supplierName String   @map("supplier_name") @db.VarChar(150)
  contactName  String?  @map("contact_name") @db.VarChar(120)
  phone        String?  @db.VarChar(30)
  email        String?  @db.VarChar(120)
  address      String?  @db.Text
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  itemPrices     SupplierItemPrice[]
  purchaseOrders PurchaseOrder[]
  invoices       Invoice[]
  expenses       Expense[]

  @@map("suppliers")
}

model Customer {
  customerId   BigInt   @id @default(autoincrement()) @map("customer_id")
  customerCode String   @unique @map("customer_code") @db.VarChar(30)
  customerName String   @map("customer_name") @db.VarChar(150)
  contactName  String?  @map("contact_name") @db.VarChar(120)
  phone        String?  @db.VarChar(30)
  email        String?  @db.VarChar(120)
  address      String?  @db.Text
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  itemPrices  CustomerItemPrice[]
  salesOrders SalesOrder[]
  invoices    Invoice[]

  @@map("customers")
}

model SupplierItemPrice {
  supplierItemPriceId BigInt   @id @default(autoincrement()) @map("supplier_item_price_id")
  supplierId          BigInt   @map("supplier_id")
  itemId              BigInt   @map("item_id")
  unitPrice           Decimal  @map("unit_price") @db.Decimal(12, 2)
  effectiveFrom       DateTime @default(now()) @map("effective_from") @db.Date
  isActive            Boolean  @default(true) @map("is_active")

  supplier Supplier @relation(fields: [supplierId], references: [supplierId])
  item     Item     @relation(fields: [itemId], references: [itemId])

  @@unique([supplierId, itemId, effectiveFrom])
  @@map("supplier_item_prices")
}

model CustomerItemPrice {
  customerItemPriceId BigInt   @id @default(autoincrement()) @map("customer_item_price_id")
  customerId          BigInt   @map("customer_id")
  itemId              BigInt   @map("item_id")
  unitPrice           Decimal  @map("unit_price") @db.Decimal(12, 2)
  effectiveFrom       DateTime @default(now()) @map("effective_from") @db.Date
  isActive            Boolean  @default(true) @map("is_active")

  customer Customer @relation(fields: [customerId], references: [customerId])
  item     Item     @relation(fields: [itemId], references: [itemId])

  @@unique([customerId, itemId, effectiveFrom])
  @@map("customer_item_prices")
}

// ---------- PURCHASE ----------

model PurchaseOrder {
  purchaseId   BigInt    @id @default(autoincrement()) @map("purchase_id")
  purchaseNo   String    @unique @map("purchase_no") @db.VarChar(30)
  supplierId   BigInt    @map("supplier_id")
  purchaseDate DateTime  @default(now()) @map("purchase_date") @db.Date
  status       DocStatus @default(DRAFT)
  notes        String?   @db.Text
  subtotal     Decimal   @default(0) @db.Decimal(12, 2)
  discount     Decimal   @default(0) @db.Decimal(12, 2)
  tax          Decimal   @default(0) @db.Decimal(12, 2)
  total        Decimal   @default(0) @db.Decimal(12, 2)
  createdBy    BigInt?   @map("created_by")
  createdAt    DateTime  @default(now()) @map("created_at")

  supplier Supplier            @relation(fields: [supplierId], references: [supplierId])
  creator  User?               @relation(fields: [createdBy], references: [userId])
  lines    PurchaseOrderLine[]
  invoices Invoice[]

  @@index([purchaseDate])
  @@map("purchase_orders")
}

model PurchaseOrderLine {
  purchaseLineId BigInt  @id @default(autoincrement()) @map("purchase_line_id")
  purchaseId     BigInt  @map("purchase_id")
  itemId         BigInt  @map("item_id")
  qty            Decimal @db.Decimal(12, 3)
  unitPrice      Decimal @map("unit_price") @db.Decimal(12, 2)
  lineTotal      Decimal @map("line_total") @db.Decimal(12, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseId], references: [purchaseId], onDelete: Cascade)
  item          Item          @relation(fields: [itemId], references: [itemId])

  @@map("purchase_order_lines")
}

// ---------- SALES / ORDERS / DISPATCH ----------

model SalesOrder {
  salesOrderId BigInt    @id @default(autoincrement()) @map("sales_order_id")
  orderNo      String    @unique @map("order_no") @db.VarChar(30)
  customerId   BigInt    @map("customer_id")
  orderDate    DateTime  @default(now()) @map("order_date") @db.Date
  status       DocStatus @default(DRAFT)
  notes        String?   @db.Text
  subtotal     Decimal   @default(0) @db.Decimal(12, 2)
  discount     Decimal   @default(0) @db.Decimal(12, 2)
  tax          Decimal   @default(0) @db.Decimal(12, 2)
  total        Decimal   @default(0) @db.Decimal(12, 2)
  createdBy    BigInt?   @map("created_by")
  createdAt    DateTime  @default(now()) @map("created_at")

  customer   Customer          @relation(fields: [customerId], references: [customerId])
  creator    User?             @relation(fields: [createdBy], references: [userId])
  lines      SalesOrderLine[]
  dispatches Dispatch[]
  invoices   Invoice[]

  @@index([orderDate])
  @@map("sales_orders")
}

model SalesOrderLine {
  salesOrderLineId BigInt  @id @default(autoincrement()) @map("sales_order_line_id")
  salesOrderId     BigInt  @map("sales_order_id")
  itemId           BigInt  @map("item_id")
  qty              Decimal @db.Decimal(12, 3)
  unitPrice        Decimal @map("unit_price") @db.Decimal(12, 2)
  lineTotal        Decimal @map("line_total") @db.Decimal(12, 2)

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [salesOrderId], onDelete: Cascade)
  item       Item       @relation(fields: [itemId], references: [itemId])

  @@map("sales_order_lines")
}

model Dispatch {
  dispatchId   BigInt    @id @default(autoincrement()) @map("dispatch_id")
  dispatchNo   String    @unique @map("dispatch_no") @db.VarChar(30)
  salesOrderId BigInt    @map("sales_order_id")
  dispatchDate DateTime  @default(now()) @map("dispatch_date")
  vehicleNo    String?   @map("vehicle_no") @db.VarChar(40)
  driverName   String?   @map("driver_name") @db.VarChar(120)
  status       DocStatus @default(DISPATCHED)
  remarks      String?   @db.Text
  createdBy    BigInt?   @map("created_by")
  createdAt    DateTime  @default(now()) @map("created_at")

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [salesOrderId])
  creator    User?      @relation(fields: [createdBy], references: [userId])

  @@map("dispatches")
}

// ---------- PRODUCTION ----------

model ProductionDay {
  productionDayId BigInt   @id @default(autoincrement()) @map("production_day_id")
  productionDate  DateTime @unique @map("production_date") @db.Date
  notes           String?  @db.Text
  recordedBy      BigInt?  @map("recorded_by")
  createdAt       DateTime @default(now()) @map("created_at")

  recorder User?            @relation(fields: [recordedBy], references: [userId])
  lines    ProductionLine[]

  @@map("production_days")
}

model ProductionLine {
  productionLineId BigInt  @id @default(autoincrement()) @map("production_line_id")
  productionDayId  BigInt  @map("production_day_id")
  itemId           BigInt  @map("item_id")
  qtyProduced      Decimal @map("qty_produced") @db.Decimal(12, 3)
  scrapQty         Decimal @default(0) @map("scrap_qty") @db.Decimal(12, 3)

  productionDay ProductionDay @relation(fields: [productionDayId], references: [productionDayId], onDelete: Cascade)
  item          Item          @relation(fields: [itemId], references: [itemId])

  @@map("production_lines")
}

// ---------- STOCK ----------

model StockMovement {
  stockMovementId BigInt       @id @default(autoincrement()) @map("stock_movement_id")
  movementDate    DateTime     @default(now()) @map("movement_date")
  movementType    MovementType @map("movement_type")
  itemId          BigInt       @map("item_id")
  qtyIn           Decimal      @default(0) @map("qty_in") @db.Decimal(12, 3)
  qtyOut          Decimal      @default(0) @map("qty_out") @db.Decimal(12, 3)
  unitCost        Decimal      @default(0) @map("unit_cost") @db.Decimal(12, 2)
  refTable        String?      @map("ref_table") @db.VarChar(50)
  refId           BigInt?      @map("ref_id")
  notes           String?      @db.Text
  createdBy       BigInt?      @map("created_by")
  createdAt       DateTime     @default(now()) @map("created_at")

  item    Item  @relation(fields: [itemId], references: [itemId])
  creator User? @relation(fields: [createdBy], references: [userId])

  @@index([movementDate])
  @@map("stock_movements")
}

model StockBalance {
  itemId    BigInt   @id @map("item_id")
  qtyOnHand Decimal  @default(0) @map("qty_on_hand") @db.Decimal(12, 3)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  item Item @relation(fields: [itemId], references: [itemId], onDelete: Cascade)

  @@map("stock_balances")
}

// ---------- INVOICES ----------

model Invoice {
  invoiceId    BigInt      @id @default(autoincrement()) @map("invoice_id")
  invoiceNo    String      @unique @map("invoice_no") @db.VarChar(30)
  invoiceType  InvoiceType @map("invoice_type")
  invoiceDate  DateTime    @default(now()) @map("invoice_date") @db.Date
  dueDate      DateTime?   @map("due_date") @db.Date
  customerId   BigInt?     @map("customer_id")
  supplierId   BigInt?     @map("supplier_id")
  salesOrderId BigInt?     @map("sales_order_id")
  purchaseId   BigInt?     @map("purchase_id")
  subtotal     Decimal     @default(0) @db.Decimal(12, 2)
  discount     Decimal     @default(0) @db.Decimal(12, 2)
  tax          Decimal     @default(0) @db.Decimal(12, 2)
  total        Decimal     @default(0) @db.Decimal(12, 2)
  status       DocStatus   @default(ISSUED)
  printTemplate String     @default("DOT_MATRIX") @map("print_template") @db.VarChar(20)

  // Purchase invoice matching
  vendorInvoiceNo    String?     @map("vendor_invoice_no") @db.VarChar(40)
  vendorInvoiceDate  DateTime?   @map("vendor_invoice_date") @db.Date
  vendorInvoiceTotal Decimal?    @map("vendor_invoice_total") @db.Decimal(12, 2)
  matchStatus        MatchStatus @default(PENDING) @map("match_status")
  mismatchAmount     Decimal     @default(0) @map("mismatch_amount") @db.Decimal(12, 2)
  matchCheckedBy     BigInt?     @map("match_checked_by")
  matchCheckedAt     DateTime?   @map("match_checked_at")

  createdBy BigInt?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  customer      Customer?      @relation(fields: [customerId], references: [customerId])
  supplier      Supplier?      @relation(fields: [supplierId], references: [supplierId])
  salesOrder    SalesOrder?    @relation(fields: [salesOrderId], references: [salesOrderId])
  purchaseOrder PurchaseOrder? @relation(fields: [purchaseId], references: [purchaseId])
  creator       User?          @relation("CreatedBy", fields: [createdBy], references: [userId])
  matchChecker  User?          @relation("MatchCheckedBy", fields: [matchCheckedBy], references: [userId])
  lines         InvoiceLine[]
  payments      Payment[]

  @@index([invoiceDate])
  @@map("invoices")
}

model InvoiceLine {
  invoiceLineId BigInt  @id @default(autoincrement()) @map("invoice_line_id")
  invoiceId     BigInt  @map("invoice_id")
  itemId        BigInt? @map("item_id")
  description   String? @db.VarChar(200)
  qty           Decimal @default(0) @db.Decimal(12, 3)
  unitPrice     Decimal @default(0) @map("unit_price") @db.Decimal(12, 2)
  lineTotal     Decimal @default(0) @map("line_total") @db.Decimal(12, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [invoiceId], onDelete: Cascade)
  item    Item?   @relation(fields: [itemId], references: [itemId])

  @@map("invoice_lines")
}

model Payment {
  paymentId   BigInt    @id @default(autoincrement()) @map("payment_id")
  paymentNo   String    @unique @map("payment_no") @db.VarChar(30)
  invoiceId   BigInt    @map("invoice_id")
  paymentDate DateTime  @default(now()) @map("payment_date") @db.Date
  amount      Decimal   @db.Decimal(12, 2)
  method      PayMethod @default(CASH)
  referenceNo String?   @map("reference_no") @db.VarChar(80)
  notes       String?   @db.Text
  receivedBy  BigInt?   @map("received_by")
  createdAt   DateTime  @default(now()) @map("created_at")

  invoice  Invoice @relation(fields: [invoiceId], references: [invoiceId])
  receiver User?   @relation(fields: [receivedBy], references: [userId])

  @@map("payments")
}

// ---------- EXPENSES & TRANSACTIONS ----------

model Expense {
  expenseId   BigInt    @id @default(autoincrement()) @map("expense_id")
  expenseNo   String    @unique @map("expense_no") @db.VarChar(30)
  expenseDate DateTime  @default(now()) @map("expense_date") @db.Date
  category    String    @db.VarChar(80)
  description String?   @db.Text
  amount      Decimal   @db.Decimal(12, 2)
  method      PayMethod @default(CASH)
  paidTo      String?   @map("paid_to") @db.VarChar(150)
  supplierId  BigInt?   @map("supplier_id")
  createdBy   BigInt?   @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")

  supplier Supplier? @relation(fields: [supplierId], references: [supplierId])
  creator  User?     @relation(fields: [createdBy], references: [userId])

  @@map("expenses")
}

model CashTransaction {
  txId         BigInt    @id @default(autoincrement()) @map("tx_id")
  txDate       DateTime  @default(now()) @map("tx_date")
  txType       TxType    @map("tx_type")
  sourceModule String?   @map("source_module") @db.VarChar(40)
  refTable     String?   @map("ref_table") @db.VarChar(50)
  refId        BigInt?   @map("ref_id")
  amountIn     Decimal   @default(0) @map("amount_in") @db.Decimal(12, 2)
  amountOut    Decimal   @default(0) @map("amount_out") @db.Decimal(12, 2)
  method       PayMethod @default(CASH)
  note         String?   @db.Text
  createdBy    BigInt?   @map("created_by")
  createdAt    DateTime  @default(now()) @map("created_at")

  creator User? @relation(fields: [createdBy], references: [userId])

  @@map("cash_transactions")
}
